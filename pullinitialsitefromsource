#!/bin/bash
#===================================================================================
#
# FILE: pullinitialsitefromsource
#
# USAGE: pullinitialsitefromsource [project type]
#
# DESCRIPTION: This will create an initial site which will be a vanilla copy from a
# framework.  It will achieve this by pulling down any source code needed from 
# repositories and creating any required databases.
#
# OPTIONS: see function ’usage’ below
# NOTES: ---
# AUTHOR: Kevin Bailey, kbailey@freewayprojects.com
# COMPANY: Freeway Projects Limited
#===================================================================================

# -------------------------------------------------------------------------------------------------
# Log all output from the script.
# 
# As we are going to be carrying out multiple steps and it is important we can see all the output
# to be able to diagnose problems.
# -------------------------------------------------------------------------------------------------

# Create a place for the log files.
sudo mkdir -p /var/log/pullpush
sudo chmod 777 /var/log/pullpush

# Create a pipe...
tmppipe=$(mktemp -u)
mkfifo ${tmppipe}

# ...then start a tee process which takes as its input the pipe - and output to the logfile (and 
# standard output) and then push the tee process into the background (subshell).
tee < ${tmppipe} /var/log/pullpush/${DATE_TIME}_${USER}_${SCRIPT_NAME}.log &

# Redirect both standard output and standard error to the pipe just created - these outputs
# will then be directed via the pipe to standard output (the current shell) and the log file.
exec &> ${tmppipe}

# This sets up the pipe to be removed - it will only be fully dropped when no process is using it.
rm ${tmppipe}

# -------------------------------------------------------------------------------------------------
# Set up the user to be able to run sudo commands - this will be revoked at the end of the script.
# -------------------------------------------------------------------------------------------------
Echo "You will need to be able to authenticate a sudo session to run this script..."
sudo -v

# -------------------------------------------------------------------------------------------------
# Set up global variables.
#
# We are going to explicitly set the script name variable.  Obviously the script name is available
# as $0 - but this is not consistent and may or may not contain the path.  Also, this means we can
# use the bash debugger without needing to handle the fact that $0 would contain something like
# 'bashdb'.
# -------------------------------------------------------------------------------------------------
SCRIPT_NAME=pullinitialsitefromsource
DATE_TIME=$(date +%Y%m%d-%H%M%S)

# -------------------------------------------------------------------------------------------------
# Import Pullpush functions.
# -------------------------------------------------------------------------------------------------
source ./pullpush_functions

# -------------------------------------------------------------------------------------------------
# Local functions
#
# Here we will define all the functions used by this script.
# -------------------------------------------------------------------------------------------------

# Output a usage message - used when the parameters input are not correct.
usage () {
  echo "Usage: $SCRIPT_NAME -t [project type] -i [initial site name (1 to 8 alphanumeric characters)]"
}

# -------------------------------------------------------------------------------------------------
# Testing parameters
# -------------------------------------------------------------------------------------------------
while getopts ":t:i:" opt; do
  case $opt in
    t)
      PROJECT_TYPE=$OPTARG
      ;;
    i)
      INITIAL_SITE_NAME=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      usage
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      usage
      exit 1
      ;;
  esac
done

# Check both parameters have had values assigned.
if [ -z $PROJECT_TYPE ] || [ -z INITIAL_SITE_NAME ]
then
    echo "The project type and the initial site name need to be set."
    usage
    exit 1
fi

# Check that the project type is valid.
if [ $PROJECT_TYPE != "drupal7" ]
then
    echo "The currently supported project type is 'drupal7'."
    exit 1
fi

# Check that the initial site name is valid.
if [ ${#INITIAL_SITE_NAME} -gt 8 ]; then
    echo "The initial site name should be no longer than 8 characters."
    usage
    exit 1
fi

# Check that only alphanumeric characters are used for the initial site name.
compressed="$(echo ${INITIAL_SITE_NAME} | sed -e 's/[^[:alnum:]]//g')"
if [ "$compressed" != "${INITIAL_SITE_NAME}" ] ; then
    echo "The initial site should only contain alphanumeric characters."
    usage
    exit 1
fi

if [ -e /home/${USER}/initial_sites/${INITIAL_SITE_NAME} ]
then
    echo "The initial site name has been used already.  Either remove the site or choose a name which has not been used already."
    usage
    exit 1
fi



# Check the Pullpush configuration file exists.
#if [ -e /etc/pullpush/pullpush.conf ]
#then
#    source /etc/pullpush/pullpush.conf
#else
#    echo
#    echo "ERROR - Pullpush configuration file not found."
#    exit 1
#fi



echo "starting the script for project type :$PROJECT_TYPE and with an intial site name of ${INITIAL_SITE_NAME}"




exit 0





# Todo - Need to check if the initial site has been created already.

DATE_TIME=`date +%Y%m%d-%H%M%S`
PROJECT_TYPE=${1}
INITIAL_SITE_NAME=${2}

# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Set up some initial variables and create the initial site directory..."
# -------------------------------------------------------------------------------------------------

# Should possibly use a better tool - but SLES does not have gpw or pwgen available.
# NB - We need to generate a shortish username to log in to the database as MySQL
# has a limit on database usernames of 16 characters.
# NB - It would be good to put hyphens inbetween the parts of the database name but 
# this causes problems with MySQL.
DATABASE_NAME=${USER}initialsite${INITIAL_SITE_NAME}
DATABASE_USER=`cat /dev/urandom | base64 | tr -d '[:punct:]' | tr -d '[:digit:]' | tr -d '[:upper:]' | cut -c1-10 | head -1`
DATABASE_PASSWORD=`cat /dev/urandom | base64 | tr -d '[:punct:]' | tr -d '[:digit:]' | tr -d '[:upper:]' | cut -c1-10 | head -1`

# Todo
# Need to check that the database name or database username has not been used already.

# We do this first to make sure the document root exists - otherwise the commands to restart Apache
# will produce warnings.
mkdir -p ~/initial_sites

# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Download site files..."
# -------------------------------------------------------------------------------------------------
case "${PROJECT_TYPE}" in

    drupal7)
	echo
	echo `date`
	echo "Download a Drupal 7 site..."
        drush dl drupal-7 --drupal-project-rename=${INITIAL_SITE_NAME} --destination=/home/${USER}/initial_sites
        ;;
    
    drupal6)
	echo
	echo `date`
	echo "Download a Drupal 6 site..."
        drush dl drupal-6 --drupal-project-rename=${INITIAL_SITE_NAME} --destination=/home/${USER}/initial_sites
        ;;

    symfonymysql)
	echo
	echo `date`
	echo "Download the Symfony framework..."
	composer create-project symfony/framework-standard-edition /home/${USER}/initial_sites/${INITIAL_SITE_NAME}/ ${SYMFONY_VERSION}
	composer --working-dir=/home/${USER}/initial_sites/${INITIAL_SITE_NAME} update
        ;;
    
    phpmysql)
	echo
	echo `date`
	echo "Set up a basic PHP page..."
	mkdir -p /home/${USER}/initial_sites/${INITIAL_SITE_NAME}
	cp /usr/local/share/pullpush/index.php.template /home/${USER}/initial_sites/${INITIAL_SITE_NAME}/index.php
        ;;
    
    *)
        echo "Error - Invalid project type."
        exit -1
esac

# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Set up the vhost for the site..."
# -------------------------------------------------------------------------------------------------
case "${SERVER_TYPE}" in

    debian)
	echo
	echo `date`
        echo "Set up vhost on Debian."

	# First we need to copy the relevant vhost template file.
	case ${PROJECT_TYPE} in
	    drupal7)
		echo "Copy the drupal7 vhost template..."
		sudo cp /usr/local/share/pullpush/vhost_drupal7.template /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}
                ;;
            drupal6)
		echo "Copy the drupal6 vhost template..."
		sudo cp /usr/local/share/pullpush/vhost_drupal6.template /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}
                ;;
	    symfonymysql)
		echo "Copy the symfonymysql vhost template..."
		sudo cp /usr/local/share/pullpush/vhost_symfonymysql.template /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}
                ;;
	    phpmysql)
		echo "Copy the phpmysql vhost template..."
		sudo cp /usr/local/share/pullpush/vhost_phpmysql.template /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}
                ;;
	    *)
		echo "Error - Invalid project type."
		exit -1
        esac

##        sudo cp /usr/local/share/pullpush/vhost_drupal7.template /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}

        # Here we will update the vhost files as necessary.  There may be a more elegant way of doing this. 

        sudo sed -i "s/documentroot/\/home\/${USER}\/initial_sites\/${INITIAL_SITE_NAME}/g" /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}

        sudo sed -i "s/username/${USER}/g" /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}
        sudo sed -i "s/vhostname/${USER}-initial-site-${INITIAL_SITE_NAME}/g" /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}
        sudo sed -i "s/serverfqdn/${SERVER_FQDN}/g" /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}
        sudo sed -i "s/serveradminemail/${SERVER_ADMIN_EMAIL}/g" /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}

        sudo a2ensite ${USER}-initial-site-${INITIAL_SITE_NAME}
        sudo apache2ctl restart
        ;;
    
    sles)
	echo
	echo `date`
        echo "Set up a vhost on SLES."
        ##sudo cp /usr/local/share/pullpush/vhost_drupal7.template /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf

	case ${PROJECT_TYPE} in
	    drupal7)
		echo "Copy th drupal7 vhost template..."
		sudo cp /usr/local/share/pullpush/vhost_drupal7.template /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf
                ;;
            drupal6)
		echo "Copy the drupal6 vhost template..."
		sudo cp /usr/local/share/pullpush/vhost_drupal6.template /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf
                ;;
	    symfonymysql)
		echo "Copy the symfonymysql vhost template..."
		sudo cp /usr/local/share/pullpush/vhost_symfonymysql.template /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf
                ;;
	    phpmysql)
		echo "Copy the phpmysql vhost template..."
		sudo cp /usr/local/share/pullpush/vhost_phpmysql.template /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf
                ;;
	    *)
		echo "Error - Invalid project type."
		exit -1
        esac

        sudo sed -i "s/documentroot/\/home\/${USER}\/initial_sites\/${INITIAL_SITE_NAME}/g" /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf

        sudo sed -i "s/username/${USER}/g" /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf
##        sudo sed -i "s/initialsitename/${INITIAL_SITE_NAME}/g" /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf
        sudo sed -i "s/vhostname/${USER}-initial-site-${INITIAL_SITE_NAME}/g" /etc/apache2/sites-available/${USER}-initial-site-${INITIAL_SITE_NAME}.conf

        sudo sed -i "s/serverfqdn/${SERVER_FQDN}/g" /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf
        sudo sed -i "s/serveradminemail/${SERVER_ADMIN_EMAIL}/g" /etc/apache2/vhosts.d/${USER}-initial-site-${INITIAL_SITE_NAME}.conf

        sudo /usr/sbin/rcapache2 restart
        ;;

    *)
        echo "Error - Invalid server type."
        exit -1
esac

# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Create the database for the site..."
# -------------------------------------------------------------------------------------------------

# We will create a database for the Drupal site.  Then, we need to allow the user full access to this database as standard 
# privileges required by Drupal do not seem to allow us the create the initial tables.  We will then change privileges
# to only those needed for Drupal.
# NB - It is possible to run the 'drush site-install' command and specify the root user for MySQL - but this would expose the
# MYSQL root user and password to anyone who can read this script - and this might include user accounts which are not in the 
# wheel group.
case "${PROJECT_TYPE}" in

    drupal7)
        echo
	echo `date`
	echo "This will set up a database for a Drupal 7 site."

        # NB - It is possible to run the 'drush site-install' command and specify the root user for MySQL - but this would expose the
        # MYSQL root user and password to anyone who can read this script - and this might include user accounts which are not in the 
        # wheel group.
	sudo mysqladmin create ${DATABASE_NAME}
	sudo mysql --execute="GRANT ALL ON ${DATABASE_NAME}.* TO '${DATABASE_USER}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD}';" ${DATABASE_NAME}
        ;;

    drupal6)
        echo
	echo `date`
	echo "Setting up a database for a Drupal 6 site..."

        # NB - It is possible to run the 'drush site-install' command and specify the root user for MySQL - but this would expose the
        # MYSQL root user and password to anyone who can read this script - and this might include user accounts which are not in the 
        # wheel group.

	sudo mysqladmin create ${DATABASE_NAME}
	sudo mysql --execute="GRANT ALL ON ${DATABASE_NAME}.* TO '${DATABASE_USER}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD}';" ${DATABASE_NAME}
        ;;

    symfonymysql)
        echo
	echo `date`
	echo "Setting up a database for a symfonymysql site..."

        # Although Symfony does not need a database we will set one up for this project type for the convenience of the developers.
	sudo mysqladmin create ${DATABASE_NAME}
	sudo mysql --execute="GRANT ALL ON ${DATABASE_NAME}.* TO '${DATABASE_USER}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD}';" ${DATABASE_NAME}
	echo 
	echo `date`
	echo "This is the database name: "
	echo ${DATABASE_NAME}
	echo "This is the database user which should be used to access the database: "
	echo ${DATABASE_USER}
	echo "This is the database username password: "
	echo ${DATABASE_PASSWORD}
        ;;

    phpmysql)
        echo
	echo `date`
	echo "Setting up a database for a phpmysql site..."

        # We will set up a database for this project type for the convenience of the developers.
	sudo mysqladmin create ${DATABASE_NAME}
	sudo mysql --execute="GRANT ALL ON ${DATABASE_NAME}.* TO '${DATABASE_USER}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD}';" ${DATABASE_NAME}
	echo 
	echo `date`
	echo "This is the database name: "
	echo ${DATABASE_NAME}
	echo "This is the database user which should be used to access the database: "
	echo ${DATABASE_USER}
	echo "This is the database username password: "
	echo ${DATABASE_PASSWORD}
        ;;
    
    *)
        echo "Error - Invalid project type."
        exit -1
esac

# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Carry out a site install on the new site based on the database just created..."
# -------------------------------------------------------------------------------------------------
case "${PROJECT_TYPE}" in

    drupal7)
	echo
	echo `date`
        echo "Carrying out a site install on the Drupal 7 site..."

##	cd ~/initial_sites/${INITIAL_SITE_NAME}

        # For D6 the profile should be 'default' and under D7 the profile should be 'standard'.
	drush site-install standard --db-url=mysql://${DATABASE_USER}:${DATABASE_PASSWORD}@localhost/${DATABASE_NAME} --yes --root=/home/${USER}/initial_sites/${INITIAL_SITE_NAME}

        # Now we've allowed the user to set up the Drupal site we're going to reduce the user
        # down to only the rights which they need to run Drupal.  We do this by revoking all 
        # rights and then only allowing the required rights.
	sudo mysql --execute="REVOKE ALL PRIVILEGES, GRANT OPTION FROM '${DATABASE_USER}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD}';" ${DATABASE_NAME}
	sudo mysql --execute="GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER, CREATE TEMPORARY TABLES, LOCK TABLES ON ${DATABASE_NAME}.* TO '${DATABASE_USER}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD}';" ${DATABASE_NAME}

	echo 
	echo `date`
	echo "This is the URL for the new site: "
	echo ${USER}-initial-site-${INITIAL_SITE_NAME}.${SERVER_FQDN}

	if [ "${APACHE_TYPE}" != "ITK" ]
	then
	    echo
	    echo `date`
	    echo "Setting permissions for the files/ directory for non-ITK sites so the web server can write to it..."
	    sudo chmod 777 -R ~/initial_sites/${INITIAL_SITE_NAME}/sites/default/files
	fi
        ;;
    
    drupal6)
	echo
	echo `date`
        echo "Carrying out a site install on the Drupal 6 site..."

##	cd ~/initial_sites/${INITIAL_SITE_NAME}

        # For D6 the profile should be 'default' and under D7 the profile should be 'standard'.
	drush site-install default --db-url=mysql://${DATABASE_USER}:${DATABASE_PASSWORD}@localhost/${DATABASE_NAME} --yes --root=/home/${USER}/initial_sites/${INITIAL_SITE_NAME}

        # Now we've allowed the user to set up the Drupal site we're going to reduce the user
        # down to only the rights which they need to run Drupal.  We do this by revoking all 
        # rights and then only allowing the required rights.
	sudo mysql --execute="REVOKE ALL PRIVILEGES, GRANT OPTION FROM '${DATABASE_USER}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD}';" ${DATABASE_NAME}
	sudo mysql --execute="GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER, CREATE TEMPORARY TABLES, LOCK TABLES ON ${DATABASE_NAME}.* TO '${DATABASE_USER}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD}';" ${DATABASE_NAME}

	echo 
	echo `date`
	echo "This is the URL for the new site: "
	echo ${USER}-initial-site-${INITIAL_SITE_NAME}.${SERVER_FQDN}

	if [ "${APACHE_TYPE}" != "ITK" ]
	then
	    echo
	    echo `date`
	    echo "Setting permissions for the files/ directory for non-ITK sites so the web server can write to it..."
	    sudo chmod 777 -R ~/initial_sites/${INITIAL_SITE_NAME}/sites/default/files
	fi
        ;;
    
    symfonymysql)
	echo
	echo `date`
        echo "Carrying out a site install on the symfonymysql site - currently no extra configuration needed for phpmysql sites..."

	echo 
	echo `date`
	echo "This is the URL for the new site: "
	echo ${USER}-initial-site-${INITIAL_SITE_NAME}.${SERVER_FQDN}/web/app_dev.php
        ;;
    
    phpmysql)
	echo
	echo `date`
        echo "Carrying out a site install on the phpmysql site - currently no extra configuration needed for phpmysql sites..."

	echo 
	echo `date`
	echo "This is the URL for the new site: "
	echo ${USER}-initial-site-${INITIAL_SITE_NAME}.${SERVER_FQDN}
        ;;
    
    *)
        echo "Error - Invalid project type."
        exit -1
esac


# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Finished."
# -------------------------------------------------------------------------------------------------

exit 0
