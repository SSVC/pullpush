#!/bin/bash

# pulllivecopyfromdatadump
# Pull live copy from data dump

# ------------------------------------------------------------------------------------------------
# Script which will create a new livecopy application using a data dump from the live application.
# ------------------------------------------------------------------------------------------------

# -------------------------------------------------------------------------------------------------
# Logging setup
# -------------------------------------------------------------------------------------------------

# These lines have been copied from http://stackoverflow.com/questions/3173131/redirect-copy-of-stdout-to-log-file-from-within-bash-script-itself
# and will send the script output to a log file.
mkdir -p ~/logs/pullpush
DATE_TIME=`date +%Y%m%d-%H%M%S`
logfile=~/logs/pullpush/pulllivecopyfromdatadump_${DATE_TIME}.log
mkfifo ${logfile}.pipe
tee < ${logfile}.pipe $logfile &
exec &> ${logfile}.pipe
rm ${logfile}.pipe

# -------------------------------------------------------------------------------------------------
# Testing for arguments and configuration files.
# -------------------------------------------------------------------------------------------------

echo
echo `date`
echo "Testing for arguments..."
if [ $1 ]
then
    echo "Project argument supplied OK as $1"
    echo
else
    echo "ERROR - No project argument supplied"
    exit -1
fi

if [ $2 ]
then
    echo "Datetime argument supplied OK as $2"
    echo
else
    echo "ERROR - No datetime argument supplied"
    exit -1
fi

# Check the variables file exists.
if [ -e ~/.pullpush/${1} ]
then
        source ~/.pullpush/$1
else
        echo "ERROR - Configuration file $1 not found."
        exit -1
fi

# Check the global settings file exists.
if [ -e /home/pullpush/.pullpush/projects/${1} ]
then
        source /home/pullpush/.pullpush/projects/${1}
else
        echo "ERROR - Global configuration file $1 not found."
        exit -1
fi

DATE_TIME=`date +%Y%m%d-%H%M%S`

PROJECT_NAME=${1}
DATETIME_STAMP=${2}

# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Load database..."
# -------------------------------------------------------------------------------------------------
mysqladmin --force -u ${LIVECOPY_MYSQL_USER} -p${LIVECOPY_MYSQL_PASS} drop ${LIVECOPY_MYSQL_DATABASE}
mysqladmin -u ${LIVECOPY_MYSQL_USER} -p${LIVECOPY_MYSQL_PASS} create ${LIVECOPY_MYSQL_DATABASE}

mysql -u ${LIVECOPY_MYSQL_USER} -p${LIVECOPY_MYSQL_PASS} ${LIVECOPY_MYSQL_DATABASE} < /home/livecopy/live_dump/${PROJECT_NAME}/${DATETIME_STAMP}_live_${PROJECT_NAME}.sql

# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Load files..."
# -------------------------------------------------------------------------------------------------
ssh livecopy@localhost "mkdir -p /home/livecopy/web/${PROJECT_NAME}"
ssh livecopy@localhost "rm -r /home/livecopy/web/${PROJECT_NAME}/*"
ssh livecopy@localhost "tar -x --file=/home/livecopy/live_dump/${PROJECT_NAME}/${DATETIME_STAMP}_live_${PROJECT_NAME}.tar --directory=/home/livecopy/web/${PROJECT_NAME} --strip-components=1"

# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Carry out project specific actions..."
# -------------------------------------------------------------------------------------------------

if [ "$PROJECT_TYPE" = "drupal7" ]
then

    # -------------------------------------------------------------------------------------------------
    echo
    echo `date`
    echo "Processing drupal7 specific code..."
    # -------------------------------------------------------------------------------------------------

    # This should be something which copies the default.settings.php to settings.php and then appends 
    # the database settings variable.
    ssh livecopy@localhost "cp /home/livecopy/settings/${PROJECT_NAME}/settings.php /home/livecopy/web/${PROJECT_NAME}/sites/default/settings.php"

    # And then changes the .htaccess file to allow access.
    ssh livecopy@localhost "cp /home/livecopy/settings/${PROJECT_NAME}/.htaccess /home/livecopy/web/${PROJECT_NAME}/.htaccess"

fi

# -------------------------------------------------------------------------------------------------
echo
echo `date`
echo "Finished..."
# -------------------------------------------------------------------------------------------------
